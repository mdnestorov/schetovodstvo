async function calculate() {
  const income = parseFloat(document.getElementById('income').value) || 0;
  const bgNoVAT = parseFloat(document.getElementById('bgNoVAT').value) || 0;
  const bgWithVAT = parseFloat(document.getElementById('bgWithVAT').value) || 0;
  const euro = parseFloat(document.getElementById('euro').value) || 0;
  const usd = parseFloat(document.getElementById('usd').value) || 0;

  const month = document.getElementById('month').value;
  const year = document.getElementById('year').value;

  if (income === 0) {
    document.getElementById("results").innerText = "❗ Въведете поне приход.";
    return;
  }

  const rateRes = await fetch('https://api.exchangerate.host/latest?base=EUR&symbols=BGN,USD');
  const data = await rateRes.json();
  const EUR_TO_BGN = data.rates.BGN || 1.95583;
  const USD_TO_BGN = (data.rates.BGN / data.rates.USD) || 1.80;

  const bgNoVATWithVAT = bgNoVAT * 1.20;
  const euroBGN = euro * EUR_TO_BGN;
  const usdBGN = usd * USD_TO_BGN;
  const euroWithVAT = euroBGN * 1.20;
  const usdWithVAT = usdBGN * 1.20;
  const vatDue = (euroBGN + usdBGN) * 0.20;

  const totalExpenses = bgNoVATWithVAT + bgWithVAT + euroWithVAT + usdWithVAT;
  const profitBeforeTax = income - totalExpenses;
  const profitTax = profitBeforeTax * 0.10;
  const netProfit = profitBeforeTax - profitTax;
  const dividendTax = netProfit * 0.05;
  const finalDividend = netProfit - dividendTax;
  const dividendMargin = income > 0 ? ((finalDividend / income) * 100).toFixed(2) : '0.00';

  latestResultText = `Финансов отчет за: ${month} ${year}\n\n`;
  latestResultText += `Курс евро: ${EUR_TO_BGN.toFixed(4)}\nКурс долар: ${USD_TO_BGN.toFixed(4)}\n\n`;
  latestResultText += `Разходи без ДДС (BGN) + ДДС: ${bgNoVATWithVAT.toFixed(2)} лв\n`;
  latestResultText += `Разходи с включен ДДС (BGN): ${bgWithVAT.toFixed(2)} лв\n`;
  latestResultText += `Разходи евро (BGN) + ДДС: ${euroWithVAT.toFixed(2)} лв\n`;
  latestResultText += `Разходи USD (BGN) + ДДС: ${usdWithVAT.toFixed(2)} лв\n`;
  latestResultText += `ДДС за внасяне (евро + USD): ${vatDue.toFixed(2)} лв\n\n`;
  latestResultText += `Общо разходи с ДДС: ${totalExpenses.toFixed(2)} лв\n`;
  latestResultText += `Облагаема печалба: ${profitBeforeTax.toFixed(2)} лв\n`;
  latestResultText += `Корпоративен данък (10%): ${profitTax.toFixed(2)} лв\n`;
  latestResultText += `Данък дивидент (5%): ${dividendTax.toFixed(2)} лв\n`;
  latestResultText += `Сума за разпределение (нетен дивидент): ${finalDividend.toFixed(2)} лв\n`;
  latestResultText += `Марж нетен дивидент: ${dividendMargin}%\n`;

  document.getElementById("results").innerText = latestResultText;
  drawChart(income, totalExpenses);
}
